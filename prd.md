# RAG原型验证系统技术需求文档 (TRD)

## 1. 项目概述

### 1.1 项目背景
构建一个基于检索增强生成(RAG)技术的原型验证系统，用于验证本地文档知识库与大语言模型结合的技术可行性。

### 1.2 项目目标
- **主要目标**: 验证RAG技术链路的完整性和可行性
- **次要目标**: 为后续产品化开发提供技术验证和架构参考

### 1.3 项目范围
- **包含**: Word文档处理、向量数据库集成、大模型API调用、命令行交互界面
- **不包含**: Web界面、用户认证、生产级部署、性能优化

---

## 2. 功能需求

### 2.1 核心功能需求

#### FR-001 文档上传与处理
- **描述**: 支持用户上传Word格式(.docx)的剧本文档
- **输入**: 本地Word文档文件
- **处理**: 
  - 提取文档文本内容
  - 清洗格式和特殊字符
  - 按语义进行文本分块(chunk size: 500-1000字符)
- **输出**: 结构化文本块列表
- **优先级**: P0(必须)
- **实现状态**: ✅ 已完成

#### FR-002 向量化与存储
- **描述**: 将文本块转换为向量并存储到Qdrant向量数据库
- **输入**: 文本块列表
- **处理**:
  - 使用embedding模型生成向量表示
  - 批量上传到Qdrant Cloud
  - 建立文本-向量映射关系
- **输出**: 向量数据库中的索引集合
- **优先级**: P0(必须)
- **实现状态**: ✅ 已完成

#### FR-003 智能问答
- **描述**: 基于向量检索和大模型生成的问答功能
- **输入**: 用户自然语言问题
- **处理**:
  - 问题向量化
  - 相似度检索(Top-K=3-5)
  - 构建包含上下文的Prompt
  - 调用DeepSeek API生成回答
- **输出**: 基于文档内容的智能回答
- **优先级**: P0(必须)
- **实现状态**: ✅ 已完成

#### FR-004 交互式命令行界面
- **描述**: 提供用户友好的CLI交互体验
- **输入**: 用户命令和查询
- **处理**: 
  - 支持文档上传命令
  - 支持持续对话模式
  - 显示处理进度和状态
- **输出**: 格式化的终端输出
- **优先级**: P1(重要)
- **实现状态**: ✅ 已完成

### 2.2 扩展功能需求

#### FR-005 多文档管理
- **描述**: 支持管理多个文档集合
- **优先级**: P2(可选)
- **实现状态**: ⏳ 计划中

#### FR-006 检索结果展示
- **描述**: 显示检索到的相关文档片段
- **优先级**: P2(可选)
- **实现状态**: ⏳ 计划中

---

## 3. 非功能需求

### 3.1 性能需求
- **响应时间**: 单次问答响应时间 < 10秒
- **并发处理**: 支持单用户操作(原型阶段)
- **文档大小**: 支持最大50MB的Word文档

### 3.2 可靠性需求
- **可用性**: 本地环境下99%可用性
- **错误处理**: 完善的异常捕获和错误提示
- **数据一致性**: 确保向量与文本数据的一致性

### 3.3 安全性需求
- **API密钥**: 通过config_values.py安全存储和使用第三方API密钥
- **数据隐私**: 本地处理，不上传敏感内容到非必要服务

### 3.4 兼容性需求
- **操作系统**: Windows 10+, macOS 12+, Ubuntu 20.04+
- **Python版本**: Python 3.8+
- **依赖管理**: 使用requirements.txt管理依赖

---

## 4. 技术架构

### 4.1 系统架构图
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   用户界面层     │    │    业务逻辑层     │    │    数据存储层    │
│                │    │                 │    │                │
│  ┌───────────┐  │    │  ┌────────────┐  │    │  ┌───────────┐ │
│  │ CLI接口   │  │────│  │文档处理模块 │  │    │  │Qdrant DB │ │
│  └───────────┘  │    │  └────────────┘  │    │  └───────────┘ │
│                │    │  ┌────────────┐  │    │                │
│                │    │  │向量化模块  │  │    │  ┌───────────┐ │
│                │    │  └────────────┘  │    │  │本地文件   │ │
│                │    │  ┌────────────┐  │    │  └───────────┘ │
│                │    │  │问答生成模块 │  │    │                │
│                │    │  └────────────┘  │    │                │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                              │
                              │
                    ┌──────────────────┐
                    │   外部服务层      │
                    │                 │
                    │  ┌────────────┐  │
                    │  │DeepSeek API│  │
                    │  └────────────┘  │
                    └──────────────────┘
```

### 4.2 技术选型

#### 4.2.1 核心组件
| 组件类型 | 选型 | 版本要求 | 选型理由 |
|---------|------|---------|---------|
| 向量数据库 | Qdrant Cloud | Latest | 云端托管，易于集成，支持高维向量 |
| 大语言模型 | DeepSeek API | v1 | OpenAI兼容接口，成本效益好 |
| ML框架 | LangChain | 0.1.0+ | 成熟的RAG开发框架 |
| 文档处理 | python-docx | 0.8.11+ | 标准Word文档处理库 |
| Embedding | text-embedding-ada-002 | - | 通过DeepSeek API调用 |

#### 4.2.2 开发环境
| 工具类型 | 选型 | 版本要求 |
|---------|------|---------|
| 编程语言 | Python | 3.8+ |
| 包管理 | pip | - |
| 代码格式 | black | - |
| 类型检查 | mypy | - |

---

## 5. 项目状态

### 5.1 已完成功能
- ✅ 文档上传与处理模块
- ✅ 向量化与存储模块
- ✅ 智能问答模块
- ✅ 命令行交互界面

### 5.2 进行中功能
- ⏳ 多文档管理功能
- ⏳ 检索结果展示优化

### 5.3 待开发功能
- 📝 批量文档处理
- 📝 文档版本管理
- 📝 检索结果排序优化

---

## 6. 部署说明

### 6.1 环境要求
- Python 3.8+
- pip包管理器
- 有效的DeepSeek API密钥
- Qdrant Cloud账号

### 6.2 安装步骤
1. 克隆代码仓库
2. 安装依赖：`pip install -r requirements.txt`
3. 配置config_values.py文件
4. 运行start.py启动系统

### 6.3 使用说明
1. 文档上传：使用upload_script.py
2. 问答交互：使用query_chat.py
3. 测试向量化：使用test_local_embedding.py

---

## 7. 测试方案

### 7.1 单元测试

#### 7.1.1 文档处理模块测试
```python
class TestDocumentProcessor:
    def test_load_valid_document()
    def test_load_invalid_document()
    def test_text_cleaning()
    def test_text_splitting()
```

#### 7.1.2 向量化模块测试
```python
class TestEmbeddingManager:
    def test_embed_single_text()
    def test_embed_multiple_texts()
    def test_embed_empty_text()
```

#### 7.1.3 向量数据库模块测试
```python
class TestQdrantManager:
    def test_create_collection()
    def test_upload_documents()
    def test_similarity_search()
    def test_delete_collection()
```

### 7.2 集成测试

#### 7.2.1 端到端测试用例
| 测试用例ID | 测试场景 | 预期结果 |
|-----------|---------|---------|
| E2E-001 | 上传Word文档并建立索引 | 成功创建向量索引 |
| E2E-002 | 基于文档内容进行问答 | 返回相关且准确的回答 |
| E2E-003 | 处理不存在的文档 | 返回适当的错误信息 |
| E2E-004 | 处理格式错误的文档 | 返回格式错误提示 |

### 7.3 性能测试

#### 7.3.1 测试指标
- 文档处理时间: <30秒/MB
- 向量生成时间: <5秒/1000字符
- 检索响应时间: <3秒
- 问答生成时间: <10秒

#### 7.3.2 测试数据
- 小文档: 1-5页Word文档
- 中文档: 10-20页Word文档  
- 大文档: 50-100页Word文档

---

## 8. 维护说明

### 8.1 日志管理
- 使用Python logging模块记录操作日志
- 日志级别: DEBUG, INFO, WARNING, ERROR
- 日志轮转: 按大小轮转，保留最近30天

### 8.2 监控指标
- API调用成功率
- 向量数据库连接状态
- 文档处理成功率
- 平均响应时间

### 8.3 故障排查
- 检查API密钥有效性
- 验证网络连接状态
- 查看详细错误日志
- 重启服务进程

---

## 9. 附录

### 9.1 依赖清单 (requirements.txt)
```
langchain>=0.1.0
openai>=1.0.0
qdrant-client>=1.7.0
python-docx>=0.8.11
tiktoken>=0.5.0
python-dotenv>=1.0.0
```

### 9.2 配置模板 (config.example.py)
```python
# DeepSeek API配置
DEEPSEEK_API_KEY = "your_deepseek_api_key_here"
DEEPSEEK_API_BASE = "https://api.deepseek.com/v1"

# Qdrant Cloud配置
QDRANT_URL = "https://your-cluster-id.qdrant.cloud"
QDRANT_API_KEY = "your_qdrant_api_key_here"
COLLECTION_NAME = "script_collection"

# 模型配置
EMBEDDING_MODEL = "text-embedding-ada-002"
CHAT_MODEL = "deepseek-chat"
VECTOR_DIM = 1536

# 处理参数
CHUNK_SIZE = 800
CHUNK_OVERLAP = 100
TOP_K = 3
MAX_TOKENS = 1000
TEMPERATURE = 0.7
```

### 9.3 错误代码定义
| 错误代码 | 错误描述 | 解决方案 |
|---------|---------|---------|
| ERR_001 | 文档文件不存在 | 检查文件路径是否正确 |
| ERR_002 | 文档格式不支持 | 确保使用.docx格式 |
| ERR_003 | API密钥无效 | 检查配置文件中的API密钥 |
| ERR_004 | 向量数据库连接失败 | 检查网络连接和数据库配置 |
| ERR_005 | 文档内容为空 | 确保文档包含有效文本内容 |

---

**文档版本**: v1.0  
**创建日期**: 2024年12月  
**最后更新**: 2024年12月  
**文档状态**: 待评审